# æ£€æŸ¥ç‚¹ä¸Šä¸‹æ–‡æ¢å¤æœºåˆ¶åˆ†æž

## é—®é¢˜æ¦‚è¿°

å½“å‰æ£€æŸ¥ç‚¹ä¸Šä¸‹æ–‡æ¢å¤é€»è¾‘å­˜åœ¨**å…³é”®æ€§æ—¶é—´æˆ³ä¸åŒ¹é…é—®é¢˜**ï¼Œå¯¼è‡´æ— æ³•å‡†ç¡®æ¢å¤åˆ°LLM APIè°ƒç”¨å‘èµ·å‰çš„æç¤ºè¯ä¸Šä¸‹æ–‡çŠ¶æ€ã€‚

## ðŸ”´ å‘çŽ°çš„ä¸»è¦é—®é¢˜

### 1. æ—¶é—´æˆ³ä¸åŒ¹é…é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- æ£€æŸ¥ç‚¹æ—¶é—´æˆ³ï¼šå½“`checkpointSave()`è¢«è°ƒç”¨æ—¶ï¼Œåˆ›å»ºgitæäº¤çš„æ¶ˆæ¯åŒ…å«`Date.now()`ï¼Œä½†è¿™ä¸ªæ—¶é—´æˆ³**å¹¶æœª**å­˜å‚¨åœ¨æ£€æŸ¥ç‚¹æœ¬èº«
- æ¶ˆæ¯æ—¶é—´æˆ³ï¼š`say("checkpoint_saved")`å‡½æ•°ä½¿ç”¨`sayTs = Date.now()`ä½œä¸ºæ¶ˆæ¯æ—¶é—´æˆ³
- APIæ¶ˆæ¯æ—¶é—´æˆ³ï¼šAPIæ¶ˆæ¯åœ¨ä¿å­˜æ—¶é€šè¿‡`messageWithTs.ts = Date.now()`èŽ·å¾—æ—¶é—´æˆ³

**å½±å“**ï¼šæ¢å¤é€»è¾‘åŸºäºŽæ¶ˆæ¯æ—¶é—´æˆ³æ¥è¿‘ä¼¼æ£€æŸ¥ç‚¹æ—¶é—´ï¼Œä½†å­˜åœ¨å»¶è¿Ÿå’Œè¯¯å·®ã€‚

### 2. é”™è¯¯çš„æ—¶é—´æˆ³é€»è¾‘

```typescript
// å½“å‰æ¢å¤é€»è¾‘
for (let i = fullHistory.length - 1; i >= 0; i--) {
    const message = fullHistory[i]
    if (message.ts && message.ts <= targetTimestamp) {
        restoreIndex = i
        break
    }
}
```

**é—®é¢˜**ï¼šæ­¤é€»è¾‘æ‰¾åˆ°**æ£€æŸ¥ç‚¹æ—¶é—´æˆ³ä¹‹å‰çš„æœ€åŽä¸€æ¡æ¶ˆæ¯**ï¼Œä½†åº”è¯¥æ‰¾åˆ°**æ£€æŸ¥ç‚¹æ—¶çš„çŠ¶æ€**ã€‚

### 3. ç¼ºå°‘æ£€æŸ¥ç‚¹æ—¶é—´æˆ³å­˜å‚¨

**é—®é¢˜æè¿°**ï¼š
- æ£€æŸ¥ç‚¹æœåŠ¡(`ShadowCheckpointService`)å­˜å‚¨gitæäº¤ï¼Œä½†ä¸å­˜å‚¨åˆ›å»ºæ£€æŸ¥ç‚¹çš„å®žé™…æ—¶é—´æˆ³
- `checkpoint_saved`æ¶ˆæ¯æ—¶é—´æˆ³ä¸Žå®žé™…æ£€æŸ¥ç‚¹åˆ›å»ºæ—¶é—´ä¸åŒ

## ðŸŸ¡ æ­£ç¡®çš„å·¥ä½œæµç¨‹

### æœŸæœ›çš„å·¥ä½œæµç¨‹ï¼š

1. **ä¿å­˜æ£€æŸ¥ç‚¹æ—¶**ï¼š
```typescript
const checkpointTimestamp = Date.now()
// ä½¿ç”¨æ­¤æ—¶é—´æˆ³ä¿å­˜æ£€æŸ¥ç‚¹
await checkpointService.saveCheckpoint(`Task: ${taskId}, Time: ${checkpointTimestamp}`)
// åœ¨æŒä¹…åŒ–å­˜å‚¨ä¸­å­˜å‚¨æ£€æŸ¥ç‚¹æ—¶é—´æˆ³
await storeCheckpointTimestamp(checkpointTimestamp, commitHash)
```

2. **æ¢å¤ä¸Šä¸‹æ–‡æ—¶**ï¼š
```typescript
// èŽ·å–æ£€æŸ¥ç‚¹æ—¶é—´æˆ³ï¼ˆä¸æ˜¯æ¶ˆæ¯æ—¶é—´æˆ³ï¼‰
const checkpointTimestamp = await getCheckpointTimestamp(commitHash)
// æ‰¾åˆ°æ­¤ç¡®åˆ‡æ—¶é—´æˆ³ä¹‹å‰çš„æ¶ˆæ¯
const restoredHistory = fullHistory.filter(msg => msg.ts <= checkpointTimestamp)
```

## ðŸŸ¢ ç«žæ€æ¡ä»¶é—®é¢˜

### æ—¶åºé—®é¢˜ï¼š
- APIè°ƒç”¨å‘èµ· â†’ æ£€æŸ¥ç‚¹ä¿å­˜ â†’ æ¶ˆæ¯å‘å¸ƒ

### ç«žæ€æ¡ä»¶ï¼š
å¦‚æžœåœ¨æ£€æŸ¥ç‚¹ä¿å­˜å’Œæ¶ˆæ¯å‘å¸ƒä¹‹é—´æ·»åŠ äº†æ¶ˆæ¯ï¼Œæ¢å¤ç‚¹å°±ä¼šå˜å¾—ä¸å‡†ç¡®ã€‚

### ç¼ºå°‘ç›´æŽ¥å…³è”ï¼š
æ£€æŸ¥ç‚¹æäº¤å’Œå®ƒæ‰€ä»£è¡¨çš„ç¡®åˆ‡æ—¶é—´æˆ³ä¹‹é—´æ²¡æœ‰ç›´æŽ¥å…³è”ã€‚

## âœ… ä¿®å¤å»ºè®®

### 1. å­˜å‚¨æ£€æŸ¥ç‚¹æ—¶é—´æˆ³
ä¿®æ”¹æ£€æŸ¥ç‚¹æœåŠ¡ä»¥å­˜å‚¨åˆ›å»ºæ£€æŸ¥ç‚¹æ—¶çš„å®žé™…æ—¶é—´æˆ³ã€‚

### 2. ä½¿ç”¨æ£€æŸ¥ç‚¹æ—¶é—´æˆ³
ä½¿ç”¨å­˜å‚¨çš„æ£€æŸ¥ç‚¹æ—¶é—´æˆ³è¿›è¡Œä¸Šä¸‹æ–‡æ¢å¤ï¼Œè€Œä¸æ˜¯æ¶ˆæ¯æ—¶é—´æˆ³ã€‚

### 3. åŒæ­¥æ—¶é—´æˆ³
ç¡®ä¿æ£€æŸ¥ç‚¹æ—¶é—´æˆ³ä¸ŽAPIæ¶ˆæ¯æ—¶é—´æˆ³åŒæ­¥ã€‚

### 4. æ·»åŠ æ¢å¤éªŒè¯
æ·»åŠ é€»è¾‘ä»¥éªŒè¯æ¢å¤çš„ä¸Šä¸‹æ–‡æ˜¯å¦ç¬¦åˆé¢„æœŸçŠ¶æ€ã€‚

## ðŸŽ¯ å½“å‰å®žçŽ°è¯„ä¼°

**ç»“è®º**ï¼šå½“å‰å®žçŽ°**å¯ä»¥å·¥ä½œ**ï¼Œä½†ç”±äºŽæ—¶é—´æˆ³ä¸åŒ¹é…å­˜åœ¨**å‡†ç¡®æ€§é—®é¢˜**ï¼Œå¯èƒ½æ— æ³•å§‹ç»ˆæ¢å¤åˆ°APIè°ƒç”¨å‰çš„**ç¡®åˆ‡**çŠ¶æ€ã€‚

**å»ºè®®**ï¼šå®žæ–½ä¸Šè¿°ä¿®å¤ä»¥ç¡®ä¿å¯é çš„ä¸Šä¸‹æ–‡æ¢å¤ã€‚