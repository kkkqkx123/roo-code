# APIå“åº”ä¸­æ–­/å¤±è´¥å¤„ç†é€»è¾‘æ·±åº¦åˆ†æ

## ğŸ” å½“å‰å®ç°åˆ†æ

### ç´¢å¼•åˆ†é…é€»è¾‘
```typescript
// MessageManager.addToApiConversationHistory
if (message.role === "assistant") {
    conversationIndex = this.getNextConversationIndex()  // åªåœ¨å“åº”æ—¶åˆ†é…ç´¢å¼•
}
```

### æ£€æŸ¥ç‚¹åˆ›å»ºé€»è¾‘
```typescript
// ApiRequestManager.processStream
const checkpointConversationIndex = await this.saveApiContextBeforeCall(...)
// åœ¨APIè¯·æ±‚å‰è·å–"å½“å‰ç´¢å¼•"ï¼Œä½†å®é™…ä¸Šæ˜¯ä¸Šä¸€ä¸ªå“åº”çš„ç´¢å¼•
```

### æ¶ˆæ¯æ·»åŠ é€»è¾‘
```typescript
// ApiRequestManager.recursivelyMakeClineRequests
if (shouldAddUserMessage) {
    await this.messageManager.addToApiConversationHistory({
        role: "user",
        content: finalUserContent,
    })
    // ç”¨æˆ·æ¶ˆæ¯ä¸åˆ†é…ç´¢å¼•
}

// åœ¨processStreamä¸­å¤„ç†å“åº”
await this.processStream(currentItem, stack)
// å“åº”å¤„ç†ä¸­ä¼šåˆ†é…æ–°ç´¢å¼•
```

## âŒ å‘ç°çš„ä¸¥é‡é—®é¢˜

### 1. ç´¢å¼•æ—¶æœºé”™ä½ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰

**é—®é¢˜æè¿°**ï¼š
- æ£€æŸ¥ç‚¹åœ¨**è¯·æ±‚å‰**åˆ›å»ºï¼Œå…³è”çš„æ˜¯**ä¸Šä¸€ä¸ªå“åº”**çš„ç´¢å¼•
- æ–°å“åº”åœ¨**è¯·æ±‚å**åˆ†é…æ–°ç´¢å¼•
- å¯¼è‡´æ£€æŸ¥ç‚¹ä¸å®é™…çš„"è¯·æ±‚-å“åº”å¯¹"ä¸åŒ¹é…

**å…·ä½“åœºæ™¯**ï¼š
```
å¯¹è¯å†å²ï¼š
[0] ç”¨æˆ·: "Hello"                    (æ— ç´¢å¼•)
[1] åŠ©æ‰‹: "Hi there"                 (ç´¢å¼•0)
[2] ç”¨æˆ·: "Write code"              (æ— ç´¢å¼•)

å½“å‰å¤„ç†ï¼š
T1: åˆ›å»ºæ£€æŸ¥ç‚¹ â†’ è·å–å½“å‰ç´¢å¼•0ï¼ˆå¯¹åº”[1]çš„å“åº”ï¼‰
T2: APIè°ƒç”¨
T3: æ¥æ”¶å“åº” â†’ åˆ†é…æ–°ç´¢å¼•1

ç»“æœï¼šæ£€æŸ¥ç‚¹å…³è”ç´¢å¼•0ï¼Œä½†å®é™…å“åº”æ˜¯ç´¢å¼•1
```

### 2. è¯·æ±‚æ¶ˆæ¯æ— ç´¢å¼•ï¼ˆè®¾è®¡ç¼ºé™·ï¼‰

**é—®é¢˜**ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼ˆè¯·æ±‚ï¼‰ä¸åˆ†é…å¯¹è¯ç´¢å¼•
- æ— æ³•å»ºç«‹"è¯·æ±‚-å“åº”å¯¹"çš„å®Œæ•´æ˜ å°„
- æ¢å¤æ—¶æ— æ³•ç¡®å®šè¯·æ±‚è¾¹ç•Œ

**å½±å“**ï¼š
- æ— æ³•ç²¾ç¡®æ¢å¤åˆ°"æŸä¸ªè¯·æ±‚ä¹‹å‰"çš„çŠ¶æ€
- åªèƒ½æ¢å¤åˆ°"æŸä¸ªå“åº”ä¹‹å"çš„çŠ¶æ€
- å¯èƒ½åŒ…å«ä¸éœ€è¦çš„åç»­è¯·æ±‚

### 3. å¼‚å¸¸å¤„ç†ç¼ºä¹ç´¢å¼•å›æ»š

**å½“å‰å¼‚å¸¸å¤„ç†**ï¼š
```typescript
try {
    // åˆ›å»ºæ£€æŸ¥ç‚¹ï¼ˆå…³è”æ—§ç´¢å¼•ï¼‰
    const checkpointConversationIndex = this.getCurrentConversationIndex()
    
    // APIè°ƒç”¨å’Œå“åº”å¤„ç†ï¼ˆä¼šåˆ†é…æ–°ç´¢å¼•ï¼‰
    const stream = await this.attemptApiRequest()
    // ... å“åº”å¤„ç†ï¼Œåˆ†é…conversationIndex = getNextConversationIndex()
    
} catch (error) {
    // å¼‚å¸¸æ—¶ï¼Œæ–°ç´¢å¼•å·²åˆ†é…ä½†å“åº”æœªå®Œæˆ
    // æ²¡æœ‰æœºåˆ¶å›æ»šå·²åˆ†é…çš„ç´¢å¼•
    if (checkContextWindowExceededError(error)) {
        // é‡è¯•æ—¶ä¼šå†æ¬¡åˆ†é…æ–°ç´¢å¼•
        retryCount++
    }
}
```

**é—®é¢˜**ï¼š
- å¼‚å¸¸æ—¶ç´¢å¼•è®¡æ•°å™¨å·²é€’å¢
- é‡è¯•æ—¶ä¼šä½¿ç”¨æ–°çš„ç´¢å¼•
- å¯¼è‡´ç´¢å¼•åºåˆ—ä¸è¿ç»­
- æ£€æŸ¥ç‚¹ä¸å®é™…çŠ¶æ€æ›´åŠ åç¦»

### 4. é‡è¯•æœºåˆ¶ç´¢å¼•æ··ä¹±

**é‡è¯•åœºæ™¯åˆ†æ**ï¼š
```typescript
while (retryCount <= maxRetries) {
    try {
        // æ¯æ¬¡é‡è¯•éƒ½åŸºäºä¸åŒçš„"å½“å‰ç´¢å¼•"åˆ›å»ºæ£€æŸ¥ç‚¹
        const checkpointConversationIndex = await this.saveApiContextBeforeCall(...)
        
        // å¦‚æœå¤±è´¥ï¼Œç´¢å¼•è®¡æ•°å™¨å·²æ”¹å˜
    } catch (error) {
        retryCount++
        // ä¸‹ä¸€æ¬¡å¾ªç¯æ—¶ï¼ŒcurrentConversationIndexå·²ç»ä¸åŒ
    }
}
```

**åæœ**ï¼š
- æ¯æ¬¡é‡è¯•çš„æ£€æŸ¥ç‚¹å…³è”ä¸åŒç´¢å¼•
- æ— æ³•ç¡®å®šå“ªä¸ªæ£€æŸ¥ç‚¹æ˜¯"æœ‰æ•ˆ"çš„
- æ¢å¤æ—¶æ— æ³•é€‰æ‹©æ­£ç¡®çš„æ£€æŸ¥ç‚¹

### 5. æµä¸­æ–­å¤„ç†ç¼ºå¤±

**æµå¤„ç†é€»è¾‘**ï¼š
```typescript
let item = await iterator.next()
while (!item.done) {
    const chunk = item.value
    await this.handleStreamChunk(chunk)
    item = await iterator.next()
}
// å¦‚æœåœ¨è¿™é‡Œä¸­æ–­ï¼ˆç½‘ç»œé”™è¯¯ã€ç”¨æˆ·å–æ¶ˆç­‰ï¼‰ï¼Ÿ
```

**ç¼ºå¤±çš„å¤„ç†**ï¼š
- ç½‘ç»œä¸­æ–­æ—¶çš„ç´¢å¼•å¤„ç†
- ç”¨æˆ·å–æ¶ˆæ“ä½œæ—¶çš„çŠ¶æ€æ¸…ç†
- éƒ¨åˆ†å“åº”çš„ç´¢å¼•æœ‰æ•ˆæ€§

## ğŸ“Š é—®é¢˜å½±å“è¯„ä¼°

### åŠŸèƒ½æ€§å½±å“
| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“æè¿° |
|------|----------|----------|
| ç´¢å¼•æ—¶æœºé”™ä½ | ğŸ”´ ä¸¥é‡ | æ£€æŸ¥ç‚¹ä¸çŠ¶æ€ä¸åŒ¹é…ï¼Œæ¢å¤ä¸å‡†ç¡® |
| è¯·æ±‚æ— ç´¢å¼• | ğŸŸ¡ ä¸­ç­‰ | æ— æ³•ç²¾ç¡®æ¢å¤åˆ°è¯·æ±‚å‰çŠ¶æ€ |
| å¼‚å¸¸æ— å›æ»š | ğŸ”´ ä¸¥é‡ | ç´¢å¼•åºåˆ—æ··ä¹±ï¼ŒçŠ¶æ€ä¸ä¸€è‡´ |
| é‡è¯•ç´¢å¼•æ··ä¹± | ğŸ”´ ä¸¥é‡ | å¤šä¸ªæ£€æŸ¥ç‚¹å…³è”ä¸åŒç´¢å¼• |
| æµä¸­æ–­ç¼ºå¤± | ğŸŸ¡ ä¸­ç­‰ | éƒ¨åˆ†çŠ¶æ€æ— æ³•æ­£ç¡®å¤„ç† |

### å¯é æ€§å½±å“
- âœ… **æ£€æŸ¥ç‚¹å¤±æ•ˆ**ï¼šæ¢å¤å¯èƒ½åˆ°é”™è¯¯çš„çŠ¶æ€
- âœ… **æ•°æ®ä¸ä¸€è‡´**ï¼šå¯¹è¯å†å²ä¸æ£€æŸ¥ç‚¹ä¸åŒ¹é…
- âœ… **è°ƒè¯•å›°éš¾**ï¼šç´¢å¼•åºåˆ—æ··ä¹±ï¼Œé—®é¢˜è¿½è¸ªå¤æ‚
- âœ… **ç”¨æˆ·ä½“éªŒå·®**ï¼šæ¢å¤åçŠ¶æ€ä¸ç¬¦åˆé¢„æœŸ

## ğŸ¯ æ ¹æœ¬é—®é¢˜æ€»ç»“

### æ ¸å¿ƒè®¾è®¡ç¼ºé™·
1. **ç´¢å¼•åˆ†é…ç­–ç•¥é”™è¯¯**ï¼šåªåœ¨å“åº”æ—¶åˆ†é…ï¼Œå¿½ç•¥äº†è¯·æ±‚çš„é‡è¦æ€§
2. **æ£€æŸ¥ç‚¹æ—¶æœºé”™è¯¯**ï¼šåœ¨è¯·æ±‚å‰åˆ›å»ºï¼Œä½†å…³è”çš„æ˜¯æ—§çŠ¶æ€
3. **ç¼ºä¹çŠ¶æ€ä¸€è‡´æ€§ä¿è¯**ï¼šå¼‚å¸¸æ—¶æ— å›æ»šæœºåˆ¶
4. **è¯·æ±‚-å“åº”å¯¹æ˜ å°„ä¸å®Œæ•´**ï¼šæ— æ³•å»ºç«‹å®Œæ•´çš„å¯¹è¯ç”Ÿå‘½å‘¨æœŸ

### éœ€è¦é‡æ–°æ€è€ƒçš„æ ¹æœ¬é—®é¢˜
1. **ç´¢å¼•åº”è¯¥ä»£è¡¨ä»€ä¹ˆï¼Ÿ** å“åº”çŠ¶æ€ vs è¯·æ±‚çŠ¶æ€ vs å¯¹è¯è½®æ¬¡
2. **æ£€æŸ¥ç‚¹åº”è¯¥æ•è·ä»€ä¹ˆï¼Ÿ** è¯·æ±‚å‰çŠ¶æ€ vs å“åº”åçŠ¶æ€
3. **å¼‚å¸¸æ—¶å¦‚ä½•ä¿æŒä¸€è‡´æ€§ï¼Ÿ** ç´¢å¼•å›æ»š vs çŠ¶æ€è¡¥å¿
4. **å¦‚ä½•å»ºç«‹è¯·æ±‚-å“åº”å¯¹çš„å®Œæ•´æ˜ å°„ï¼Ÿ**

## ğŸ”§ æ”¹è¿›æ–¹å‘å»ºè®®

### 1. é‡æ–°è®¾è®¡ç´¢å¼•è¯­ä¹‰
**é€‰é¡¹Aï¼šåŸºäºè¯·æ±‚ç´¢å¼•ï¼ˆæ¨èï¼‰**
- æ¯ä¸ªAPIè¯·æ±‚åˆ†é…å”¯ä¸€ç´¢å¼•
- å“åº”è¯¥ç»§æ‰¿è¯·æ±‚çš„ç´¢å¼•
- æ£€æŸ¥ç‚¹åœ¨è¯·æ±‚å‰åˆ›å»ºï¼Œå…³è”è¯·æ±‚ç´¢å¼•

**é€‰é¡¹Bï¼šåŸºäºå¯¹è¯è½®æ¬¡**
- æ¯ä¸ªå®Œæ•´çš„è¯·æ±‚-å“åº”å¯¹åˆ†é…ç´¢å¼•
- ç´¢å¼•ä»£è¡¨å®Œæ•´çš„å¯¹è¯è½®æ¬¡
- æ£€æŸ¥ç‚¹æ•è·è½®æ¬¡å®Œæˆåçš„çŠ¶æ€

**é€‰é¡¹Cï¼šåŸºäºå“åº”çŠ¶æ€**
- ä¿æŒå½“å‰è®¾è®¡ï¼Œä½†ä¿®æ­£æ—¶æœºé—®é¢˜
- æ£€æŸ¥ç‚¹åœ¨å“åº”ååˆ›å»º
- éœ€è¦è§£å†³å¼‚å¸¸æ—¶çš„çŠ¶æ€ä¸€è‡´æ€§

### 2. å»ºç«‹è¯·æ±‚-å“åº”å¯¹æ˜ å°„
- ç”¨æˆ·æ¶ˆæ¯ä¹Ÿåˆ†é…ç´¢å¼•ï¼ˆæˆ–å…³è”ç´¢å¼•ï¼‰
- å»ºç«‹æ˜ç¡®çš„è¯·æ±‚-å“åº”å…³ç³»
- æ”¯æŒç²¾ç¡®çš„çŠ¶æ€æ¢å¤

### 3. å¼‚å¸¸å¤„ç†å¢å¼º
- ç´¢å¼•åˆ†é…çš„åŸå­æ€§
- å¼‚å¸¸æ—¶çš„çŠ¶æ€å›æ»š
- é‡è¯•æ—¶çš„ç´¢å¼•ä¸€è‡´æ€§

### 4. æµä¸­æ–­å¤„ç†
- ç½‘ç»œä¸­æ–­çš„æ£€æµ‹å’Œå¤„ç†
- éƒ¨åˆ†å“åº”çš„çŠ¶æ€æ¸…ç†
- ç”¨æˆ·å–æ¶ˆçš„ä¸€è‡´æ€§ä¿è¯

åç»­éœ€è¦æ ¹æ®è¿™äº›åˆ†æé‡æ–°è®¾è®¡ç´¢å¼•ç­–ç•¥å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶ã€‚