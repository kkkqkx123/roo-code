# åŸºäºå¯¹è¯ç´¢å¼•çš„æ£€æŸ¥ç‚¹æ¢å¤æœºåˆ¶è®¾è®¡

## è®¾è®¡æ¦‚è¿°

é‡æ–°è®¾è®¡äº†æ£€æŸ¥ç‚¹ä¸Šä¸‹æ–‡æ¢å¤æœºåˆ¶ï¼Œä½¿ç”¨**LLMå“åº”å¯¹è¯ç´¢å¼•**æ›¿ä»£åŸæœ‰çš„æ—¶é—´æˆ³æœºåˆ¶ï¼Œè§£å†³äº†æ—¶é—´æˆ³ä¸åŒ¹é…ã€ç«æ€æ¡ä»¶ç­‰æ ¹æœ¬æ€§é—®é¢˜ã€‚

## ğŸ”§ æ ¸å¿ƒæ”¹è¿›

### 1. å¯¹è¯ç´¢å¼•ç³»ç»Ÿ
- **åŸç†**ï¼šä¸ºæ¯ä¸ªLLMåŠ©æ‰‹å“åº”åˆ†é…ä¸€ä¸ªé€’å¢çš„å¯¹è¯ç´¢å¼•ï¼ˆconversationIndexï¼‰
- **å®ç°**ï¼šä»0å¼€å§‹ï¼Œæ¯æ¬¡åŠ©æ‰‹å“åº”æ—¶è‡ªåŠ¨é€’å¢
- **ä¼˜åŠ¿**ï¼šç²¾ç¡®ã€æ— ç«æ€æ¡ä»¶ã€æ— éœ€å¤æ‚æ—¶é—´åŒæ­¥

### 2. æ£€æŸ¥ç‚¹åˆ›å»ºä¼˜åŒ–
- **æ—¶æœº**ï¼šä»åœ¨APIè¯·æ±‚å‰åˆ›å»ºï¼Œä½†è®°å½•å½“å‰å¯¹è¯ç´¢å¼•è€Œéæ—¶é—´æˆ³
- **å­˜å‚¨**ï¼šæ£€æŸ¥ç‚¹æœåŠ¡å­˜å‚¨å¯¹è¯ç´¢å¼•åˆ°å†…å­˜æ˜ å°„ä¸­
- **ç®€åŒ–**ï¼šä¸å†éœ€è¦å¤æ‚çš„æ—¶é—´æˆ³åŒæ­¥é€»è¾‘

### 3. ä¸Šä¸‹æ–‡æ¢å¤æœºåˆ¶
- **å®šä½**ï¼šé€šè¿‡å¯¹è¯ç´¢å¼•ç²¾ç¡®å®šä½åˆ°ç‰¹å®šçš„LLMå“åº”
- **æ¢å¤**ï¼šæ¢å¤åˆ°è¯¥ç´¢å¼•å¯¹åº”çš„å®Œæ•´å¯¹è¯çŠ¶æ€
- **å‡†ç¡®æ€§**ï¼š100%ç²¾ç¡®ï¼Œæ— æ—¶é—´è¯¯å·®

## ğŸ“‹ å…·ä½“å®ç°

### APIæ¶ˆæ¯ç»“æ„å¢å¼º
```typescript
export type ApiMessage = Anthropic.MessageParam & {
  // ... åŸæœ‰å­—æ®µ
  conversationIndex?: number  // æ–°å¢ï¼šå¯¹è¯ç´¢å¼•
}
```

### å¯¹è¯ç´¢å¼•ç®¡ç†
```typescript
// MessageManagerä¸­ç®¡ç†å¯¹è¯ç´¢å¼•
private conversationIndexCounter: number = 0

getNextConversationIndex(): number {
  return this.conversationIndexCounter++
}
```

### æ£€æŸ¥ç‚¹æœåŠ¡å¢å¼º
```typescript
// ShadowCheckpointServiceä¸­å­˜å‚¨å¯¹è¯ç´¢å¼•
protected _checkpointTimestamps: Map<string, number> = new Map()

// æ–°å¢æ–¹æ³•è·å–æ£€æŸ¥ç‚¹å¯¹è¯ç´¢å¼•
getCheckpointTimestamp(commitHash: string): number | undefined
storeCheckpointTimestamp(commitHash: string, timestamp: number): void
```

### ä¸Šä¸‹æ–‡æ¢å¤é€»è¾‘
```typescript
// åŸºäºå¯¹è¯ç´¢å¼•çš„æ¢å¤
async restoreContextFromPersistedDataByIndex(targetConversationIndex: number): Promise<boolean> {
  // æ‰¾åˆ°ç›®æ ‡å¯¹è¯ç´¢å¼•çš„æ¢å¤ç‚¹
  for (let i = fullHistory.length - 1; i >= 0; i--) {
    const message = fullHistory[i]
    if (message.role === "assistant" && 
        message.conversationIndex !== undefined && 
        message.conversationIndex <= targetConversationIndex) {
      restoreIndex = i
      break
    }
  }
  // æ¢å¤åˆ°è¯¥ç‚¹
  const restoredHistory = fullHistory.slice(0, restoreIndex + 1)
}
```

## ğŸ¯ å·¥ä½œæµç¨‹

### 1. æ­£å¸¸æµç¨‹
```
ç”¨æˆ·æ¶ˆæ¯ â†’ APIè¯·æ±‚å‰åˆ›å»ºæ£€æŸ¥ç‚¹ â†’ è®°å½•å½“å‰å¯¹è¯ç´¢å¼• â†’ LLMå“åº” â†’ åˆ†é…æ–°å¯¹è¯ç´¢å¼•
```

### 2. æ¢å¤æµç¨‹
```
é€‰æ‹©æ¢å¤ç‚¹ â†’ è·å–æ£€æŸ¥ç‚¹å¯¹è¯ç´¢å¼• â†’ æ‰¾åˆ°å¯¹åº”LLMå“åº” â†’ æ¢å¤åˆ°è¯¥çŠ¶æ€
```

## âœ… è§£å†³çš„åŸæœ‰é—®é¢˜

### âŒ åŸæ—¶é—´æˆ³æœºåˆ¶é—®é¢˜ï¼š
1. **æ—¶é—´æˆ³ä¸åŒ¹é…**ï¼šæ£€æŸ¥ç‚¹æ—¶é—´æˆ³ä¸æ¶ˆæ¯æ—¶é—´æˆ³ä¸åŒæ­¥
2. **ç«æ€æ¡ä»¶**ï¼šæ¶ˆæ¯åˆ›å»ºä¸æ£€æŸ¥ç‚¹åˆ›å»ºä¹‹é—´çš„æ—¶åºé—®é¢˜
3. **ç²¾åº¦é—®é¢˜**ï¼šæ¯«ç§’çº§æ—¶é—´æˆ³ä»å¯èƒ½æœ‰è¯¯å·®
4. **å¤æ‚æ€§**ï¼šéœ€è¦å¤æ‚çš„æ—¶é—´æˆ³åŒæ­¥é€»è¾‘

### âœ… æ–°å¯¹è¯ç´¢å¼•æœºåˆ¶ä¼˜åŠ¿ï¼š
1. **ç²¾ç¡®æ€§**ï¼šåŸºäºæ•´æ•°ç´¢å¼•ï¼Œ100%ç²¾ç¡®
2. **ç®€å•æ€§**ï¼šæ— éœ€æ—¶é—´åŒæ­¥ï¼Œé€»è¾‘æ¸…æ™°
3. **æ— ç«æ€**ï¼šç´¢å¼•åˆ†é…åŸå­æ“ä½œ
4. **å¯è¿½è¸ª**ï¼šæ˜“äºè°ƒè¯•å’ŒéªŒè¯

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### æ£€æŸ¥ç‚¹åˆ›å»ºä¼˜åŒ–
- **æŒ‰éœ€åˆ›å»º**ï¼šä»…åœ¨APIè¯·æ±‚å‰åˆ›å»º
- **è½»é‡çº§**ï¼šå­˜å‚¨ç´¢å¼•è€Œéå¤æ‚æ•°æ®ç»“æ„
- **å†…å­˜é«˜æ•ˆ**ï¼šä½¿ç”¨Mapå­˜å‚¨ï¼Œå¿«é€ŸæŸ¥æ‰¾

### æ¢å¤æ€§èƒ½
- **O(n)æŸ¥æ‰¾**ï¼šå•æ¬¡éå†æ‰¾åˆ°ç›®æ ‡ç´¢å¼•
- **ç²¾ç¡®æˆªæ–­**ï¼šç›´æ¥sliceåˆ°ç›®æ ‡ä½ç½®
- **æ— é‡è®¡ç®—**ï¼šæ— éœ€æ—¶é—´æˆ³æ¯”è¾ƒå’Œè½¬æ¢

## ğŸ“Š å¯¹æ¯”æ€»ç»“

| æ–¹é¢ | åŸæ—¶é—´æˆ³æœºåˆ¶ | æ–°å¯¹è¯ç´¢å¼•æœºåˆ¶ |
|------|-------------|---------------|
| ç²¾ç¡®æ€§ | âŒ æœ‰è¯¯å·® | âœ… 100%ç²¾ç¡® |
| å¤æ‚æ€§ | âŒ é«˜å¤æ‚åº¦ | âœ… ç®€å•æ¸…æ™° |
| æ€§èƒ½ | âŒ æ—¶é—´æ¯”è¾ƒ | âœ… æ•´æ•°æ¯”è¾ƒ |
| è°ƒè¯• | âŒ æ—¶é—´éš¾è¿½è¸ª | âœ… ç´¢å¼•æ˜“éªŒè¯ |
| ç«æ€æ¡ä»¶ | âŒ å­˜åœ¨é£é™© | âœ… å®Œå…¨é¿å… |

## ğŸ”® æœªæ¥æ‰©å±•

æ­¤è®¾è®¡ä¸ºæœªæ¥çš„å¢å¼ºåŠŸèƒ½å¥ å®šäº†åŸºç¡€ï¼š
- **é€‰æ‹©æ€§æ¢å¤**ï¼šå¯ä»¥æ¢å¤åˆ°ä»»æ„LLMå“åº”çŠ¶æ€
- **åˆ†æ”¯ç®¡ç†**ï¼šæ”¯æŒå¯¹è¯å†å²çš„ä¸åŒåˆ†æ”¯
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šç±»ä¼¼Gitçš„ç‰ˆæœ¬ç®¡ç†æœºåˆ¶
- **è°ƒè¯•æ”¯æŒ**ï¼šç²¾ç¡®çš„çŠ¶æ€å›æº¯èƒ½åŠ›