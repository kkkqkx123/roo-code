# Core 模块重构计划

## 现状分析

### 主要问题

#### 1. Task.ts 过于庞大 (2000+ 行)
- **问题**: 混合了业务逻辑、状态管理、工具调用等多个职责
- **影响**: 难以维护，测试困难，新功能开发缓慢
- **优先级**: 🔴 最高

#### 2. 工具系统逻辑分散
- **问题**: 工具实现在 `tools/`，提示在 `prompts/tools/`，验证在多个地方
- **影响**: 修改工具需要改动多个文件，容易遗漏
- **优先级**: 🟡 中等

#### 3. 模块间耦合度过高
- **问题**: `ClineProvider` 依赖太多内部模块，存在循环依赖风险
- **影响**: 修改一个模块可能影响多个其他模块
- **优先级**: 🟡 中等

#### 4. 配置管理分散
- **问题**: 配置逻辑分散在各个模块中
- **影响**: 配置变更需要修改多个地方
- **优先级**: 🟢 较低

## 重构目标

### 核心原则
- ✅ **不引入新的抽象层**
- ✅ **保持现有接口不变**
- ✅ **逐步重构，小步快跑**
- ✅ **优先解决文件过大问题**
- ✅ **合并分散的逻辑**

### 预期收益
- 降低维护成本
- 提高代码可读性
- 简化新功能开发
- 改善测试覆盖率

## 具体重构计划

### 第一阶段：拆分 Task.ts (优先级：最高)

#### 目标
将 Task.ts 拆分为 4-5 个专注的模块，每个模块 <500 行

#### 拆分方案
```
src/core/task/
├── Task.ts              # 核心协调逻辑 (精简到 ~400行)
├── TaskState.ts         # 状态管理 (~300行)
├── TaskExecutor.ts      # 工具执行逻辑 (~400行)
├── TaskContext.ts       # 上下文管理 (~300行)
└── TaskMessage.ts       # 消息处理 (~300行)
```

#### 实施步骤
1. **提取状态管理** (1-2 天)
   - 将所有状态相关代码移到 TaskState.ts
   - 保持 Task.ts 中的状态访问接口不变

2. **提取工具执行** (2-3 天)
   - 将工具调用逻辑移到 TaskExecutor.ts
   - 保持工具调用接口不变

3. **提取上下文管理** (1-2 天)
   - 将上下文相关逻辑移到 TaskContext.ts
   - 包括文件追踪、环境信息等

4. **提取消息处理** (1-2 天)
   - 将消息处理逻辑移到 TaskMessage.ts
   - 包括消息解析、格式化等

#### 风险控制
- 每次只拆分一个模块
- 保持所有现有测试通过
- 添加新模块的单元测试

### 第二阶段：合并工具相关逻辑

#### 目标
每个工具的所有相关文件放在同一个目录

#### 目录结构
```
src/core/tools/
├── read-file/
│   ├── index.ts           # 工具实现
│   ├── prompt.ts          # 提示生成
│   └── validator.ts       # 参数验证
├── write-file/
├── execute-command/
└── ...其他工具
```

#### 实施步骤
1. **选择 2-3 个常用工具试点** (2-3 天)
   - read-file, write-file, execute-command
   - 验证新模式的可行性

2. **逐步迁移其他工具** (1-2 周)
   - 每次迁移 2-3 个工具
   - 保持向后兼容

### 第三阶段：简化 ClineProvider

#### 目标
使用组合模式，将职责委托给专门的协调器

#### 重构方案
```
src/core/webview/
├── ClineProvider.ts      # 只负责 VS Code 接口
├── TaskCoordinator.ts    # 任务生命周期管理
├── MessageCoordinator.ts # 消息协调
└── ToolCoordinator.ts    # 工具调用协调
```

#### 实施步骤
1. **提取 TaskCoordinator** (3-4 天)
   - 将任务相关逻辑移到 TaskCoordinator
   - ClineProvider 通过 TaskCoordinator 操作任务

2. **提取 MessageCoordinator** (2-3 天)
   - 将消息处理逻辑移到 MessageCoordinator
   - 统一消息处理接口

### 第四阶段：统一配置管理

#### 目标
建立统一的配置服务，减少配置分散

#### 实施步骤
1. **创建 ConfigService** (2-3 天)
   - 提供统一的配置访问接口
   - 支持配置验证和默认值

2. **逐步替换现有配置访问** (1-2 周)
   - 每次替换 2-3 个模块
   - 保持配置接口兼容

## 时间计划

### 总体时间估算：4-6 周

| 阶段 | 任务 | 时间 | 累计 |
|------|------|------|------|
| 一 | 拆分 Task.ts | 1-2 周 | 1-2 周 |
| 二 | 合并工具逻辑 | 1-2 周 | 2-4 周 |
| 三 | 简化 ClineProvider | 1-2 周 | 3-6 周 |
| 四 | 统一配置管理 | 1 周 | 4-6 周 |

### 里程碑
- **第 1 周末**：Task.ts 拆分完成
- **第 3 周末**：工具逻辑合并完成
- **第 5 周末**：ClineProvider 简化完成
- **第 6 周末**：配置管理统一完成

## 风险控制

### 技术风险
1. **接口变更风险**
   - 措施：保持现有接口不变，只移动实现

2. **功能回归风险**
   - 措施：每次重构都要有完整的测试覆盖

3. **合并冲突风险**
   - 措施：频繁 rebase，小步提交

### 进度风险
1. **任务复杂度低估**
   - 措施：预留 20% 时间缓冲

2. **外部依赖变化**
   - 措施：关注主分支变化，及时调整计划

## 验收标准

### 功能验收
- [ ] 所有现有功能正常工作
- [ ] 所有现有测试通过
- [ ] 性能不下降

### 代码质量验收
- [ ] Task.ts < 500 行
- [ ] 每个工具模块 < 300 行
- [ ] 代码复杂度降低
- [ ] 测试覆盖率提升

### 维护性验收
- [ ] 新功能开发时间缩短
- [ ] Bug 修复时间缩短
- [ ] 代码审查通过率提升

## 后续优化

### 可选优化（根据重构效果决定）
1. **引入依赖注入**
   - 时机：在模块边界清晰后
   - 好处：进一步降低耦合

2. **事件驱动架构**
   - 时机：模块间通信复杂时
   - 好处：解耦模块间依赖

3. **插件化架构**
   - 时机：工具数量大幅增长时
   - 好处：支持动态加载工具

## 总结

本次重构聚焦于解决实际问题，不引入不必要的抽象。通过逐步拆分大文件、合并分散逻辑，预期可以：

- 降低维护成本 30%
- 提高开发效率 20%
- 改善代码可读性
- 为后续功能开发打下良好基础

重构过程中将严格控制风险，确保现有功能不受影响。