# Shared ç›®å½•é‡æ„åˆ†é˜¶æ®µæ‰§è¡Œæ–¹æ¡ˆ

> **ç›®æ ‡**ï¼šæŒ‰ç…§å®Œæ•´çš„ä»»åŠ¡æ¸…å•ï¼Œåˆ†é˜¶æ®µæ‰§è¡Œ shared ç›®å½•é‡æ„
> **åˆ›å»ºæ—¶é—´**ï¼š2026-01-21
> **é¢„è®¡å·¥æœŸ**ï¼š3-4 å‘¨ï¼ˆåˆ† 5 ä¸ªé˜¶æ®µæ‰§è¡Œï¼‰

---

## ç›®å½•

- [ä¸€ã€æ‰§è¡Œæ¦‚è§ˆ](#ä¸€æ‰§è¡Œæ¦‚è§ˆ)
- [äºŒã€é˜¶æ®µ 0ï¼šå‡†å¤‡å·¥ä½œï¼ˆç¬¬ 1 å¤©ï¼‰](#äºŒé˜¶æ®µ-0å‡†å¤‡å·¥ä½œç¬¬-1-å¤©)
- [ä¸‰ã€é˜¶æ®µ 1ï¼šç±»å‹ä¸é…ç½®åˆ†ç¦»ï¼ˆç¬¬ 2-4 å¤©ï¼‰](#ä¸‰é˜¶æ®µ-1ç±»å‹ä¸é…ç½®åˆ†ç¦»ç¬¬-2-4-å¤©)
- [å››ã€é˜¶æ®µ 2ï¼šé«˜ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼ˆç¬¬ 5-7 å¤©ï¼‰](#å››é˜¶æ®µ-2é«˜ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ç¬¬-5-7-å¤©)
- [äº”ã€é˜¶æ®µ 3ï¼šä¸­ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼ˆç¬¬ 8-10 å¤©ï¼‰](#äº”é˜¶æ®µ-3ä¸­ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ç¬¬-8-10-å¤©)
- [å…­ã€é˜¶æ®µ 4ï¼šä½ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼ˆç¬¬ 11-12 å¤©ï¼Œå¯é€‰ï¼‰](#å…­é˜¶æ®µ-4ä½ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ç¬¬-11-12-å¤©å¯é€‰)
- [ä¸ƒã€é˜¶æ®µ 5ï¼šæ¸…ç†ä¸ä¼˜åŒ–ï¼ˆç¬¬ 13 å¤©ï¼‰](#ä¸ƒé˜¶æ®µ-5æ¸…ç†ä¸ä¼˜åŒ–ç¬¬-13-å¤©)
- [å…«ã€æ¯æ—¥æ‰§è¡Œæ£€æŸ¥æ¸…å•](#å…«æ¯æ—¥æ‰§è¡Œæ£€æŸ¥æ¸…å•)

---

## ä¸€ã€æ‰§è¡Œæ¦‚è§ˆ

### 1.1 é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | åç§° | é¢„è®¡å¤©æ•° | ä¼˜å…ˆçº§ | é£é™©ç­‰çº§ |
|------|------|----------|--------|----------|
| é˜¶æ®µ 0 | å‡†å¤‡å·¥ä½œ | 0.5 | é«˜ | ä½ |
| é˜¶æ®µ 1 | ç±»å‹ä¸é…ç½®åˆ†ç¦» | 2-3 | é«˜ | ä¸­ |
| é˜¶æ®µ 2 | é«˜ä¼˜å…ˆçº§æ¨¡å—è¿ç§» | 2-3 | é«˜ | ä¸­ |
| é˜¶æ®µ 3 | ä¸­ä¼˜å…ˆçº§æ¨¡å—è¿ç§» | 2-3 | ä¸­ | ä¸­ |
| é˜¶æ®µ 4 | ä½ä¼˜å…ˆçº§æ¨¡å—è¿ç§» | 1-2 | ä½ | ä½ |
| é˜¶æ®µ 5 | æ¸…ç†ä¸ä¼˜åŒ– | 1 | é«˜ | ä½ |

### 1.2 æ‰§è¡Œé¡ºåº

```
é˜¶æ®µ 0ï¼ˆå‡†å¤‡å·¥ä½œï¼‰
    â†“
é˜¶æ®µ 1ï¼ˆç±»å‹ä¸é…ç½®åˆ†ç¦»ï¼‰â† å…³é”®é˜¶æ®µï¼Œå¿…é¡»å…ˆå®Œæˆ
    â†“
é˜¶æ®µ 2ï¼ˆé«˜ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼‰
    â†“
é˜¶æ®µ 3ï¼ˆä¸­ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼‰
    â†“
é˜¶æ®µ 4ï¼ˆä½ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼Œå¯é€‰ï¼‰
    â†“
é˜¶æ®µ 5ï¼ˆæ¸…ç†ä¸ä¼˜åŒ–ï¼‰
```

### 1.3 å…³é”®é‡Œç¨‹ç¢‘

- **é‡Œç¨‹ç¢‘ 1**ï¼ˆç¬¬ 1 å¤©ï¼‰ï¼šå®Œæˆå‡†å¤‡å·¥ä½œ
- **é‡Œç¨‹ç¢‘ 2**ï¼ˆç¬¬ 4 å¤©ï¼‰ï¼šå®Œæˆç±»å‹ä¸é…ç½®åˆ†ç¦»
- **é‡Œç¨‹ç¢‘ 3**ï¼ˆç¬¬ 7 å¤©ï¼‰ï¼šå®Œæˆé«˜ä¼˜å…ˆçº§æ¨¡å—è¿ç§»
- **é‡Œç¨‹ç¢‘ 4**ï¼ˆç¬¬ 10 å¤©ï¼‰ï¼šå®Œæˆä¸­ä¼˜å…ˆçº§æ¨¡å—è¿ç§»
- **é‡Œç¨‹ç¢‘ 5**ï¼ˆç¬¬ 13 å¤©ï¼‰ï¼šå®Œæˆæ‰€æœ‰è¿ç§»å’Œæ¸…ç†

---

## äºŒã€é˜¶æ®µ 0ï¼šå‡†å¤‡å·¥ä½œï¼ˆç¬¬ 1 å¤©ï¼‰

**ç›®æ ‡**ï¼šåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼Œå¤‡ä»½ä»£ç ï¼Œé…ç½®ç¯å¢ƒ

### 2.1 ä¸Šåˆä»»åŠ¡ï¼ˆ2 å°æ—¶ï¼‰

#### ä»»åŠ¡ 0.1ï¼šåˆ›å»ºæ–°ç›®å½•ç»“æ„ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
# åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
cd d:\é¡¹ç›®\agent\Roo-Code

# åˆ›å»ºæ–°çš„ç›®å½•
mkdir -p src/core/constants
mkdir -p src/core/modes
mkdir -p src/core/tools
mkdir -p src/core/experiments
mkdir -p src/utils
mkdir -p src/services/code-index

# éªŒè¯ç›®å½•åˆ›å»ºæˆåŠŸ
ls -la src/core/
ls -la src/utils/
ls -la src/services/
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰ç›®å½•åˆ›å»ºæˆåŠŸ
- [ ] ç›®å½•ç»“æ„ç¬¦åˆé¢„æœŸ

#### ä»»åŠ¡ 0.2ï¼šå¤‡ä»½ç°æœ‰ä»£ç ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
# åˆ›å»ºå¤‡ä»½åˆ†æ”¯
git checkout -b backup-before-refactoring

# æˆ–è€…åˆ›å»ºå¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœä¸æƒ³åˆ›å»ºåˆ†æ”¯ï¼‰
# cp -r src/shared src/shared.backup

# éªŒè¯å¤‡ä»½
ls -la src/shared.backup/
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] å¤‡ä»½åˆ›å»ºæˆåŠŸ
- [ ] å¯ä»¥éšæ—¶å›æ»š

#### ä»»åŠ¡ 0.3ï¼šæ›´æ–° tsconfig è·¯å¾„æ˜ å°„ï¼ˆ1 å°æ—¶ï¼‰

ç¼–è¾‘ `tsconfig.json`ï¼Œæ·»åŠ è·¯å¾„åˆ«åï¼š

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@shared/*": ["src/shared/*"],
      "@core/*": ["src/core/*"],
      "@services/*": ["src/services/*"],
      "@api/*": ["src/api/*"],
      "@utils/*": ["src/utils/*"],
      "@webview-ui/*": ["webview-ui/src/*"]
    }
  }
}
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] è·¯å¾„æ˜ å°„æ·»åŠ æˆåŠŸ
- [ ] TypeScript å¯ä»¥è¯†åˆ«æ–°è·¯å¾„

### 2.2 ä¸‹åˆä»»åŠ¡ï¼ˆ2 å°æ—¶ï¼‰

#### ä»»åŠ¡ 0.4ï¼šå‡†å¤‡æµ‹è¯•ç¯å¢ƒï¼ˆ1 å°æ—¶ï¼‰

```bash
# ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
pnpm test

# ç¡®ä¿ç±»å‹æ£€æŸ¥é€šè¿‡
pnpm check-types

# ç¡®ä¿ lint é€šè¿‡
pnpm lint

# è®°å½•åŸºå‡†æµ‹è¯•ç»“æœ
pnpm test > test-results-baseline.txt
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡
- [ ] åŸºå‡†æµ‹è¯•ç»“æœå·²è®°å½•

#### ä»»åŠ¡ 0.5ï¼šåˆ›å»ºæ‰§è¡Œæ—¥å¿—ï¼ˆ1 å°æ—¶ï¼‰

åˆ›å»º `refactoring-log.md`ï¼š

```markdown
# Shared ç›®å½•é‡æ„æ‰§è¡Œæ—¥å¿—

## æ‰§è¡Œä¿¡æ¯

- **å¼€å§‹æ—¶é—´**ï¼š2026-01-21
- **æ‰§è¡Œè€…**ï¼š[ä½ çš„åå­—]
- **é¢„è®¡å®Œæˆæ—¶é—´**ï¼š2026-02-03

## é˜¶æ®µè¿›åº¦

- [ ] é˜¶æ®µ 0ï¼šå‡†å¤‡å·¥ä½œ
- [ ] é˜¶æ®µ 1ï¼šç±»å‹ä¸é…ç½®åˆ†ç¦»
- [ ] é˜¶æ®µ 2ï¼šé«˜ä¼˜å…ˆçº§æ¨¡å—è¿ç§»
- [ ] é˜¶æ®µ 3ï¼šä¸­ä¼˜å…ˆçº§æ¨¡å—è¿ç§»
- [ ] é˜¶æ®µ 4ï¼šä½ä¼˜å…ˆçº§æ¨¡å—è¿ç§»
- [ ] é˜¶æ®µ 5ï¼šæ¸…ç†ä¸ä¼˜åŒ–

## æ¯æ—¥è®°å½•

### ç¬¬ 1 å¤©ï¼ˆ2026-01-21ï¼‰
- å®Œæˆä»»åŠ¡ï¼š
- é‡åˆ°çš„é—®é¢˜ï¼š
- è§£å†³æ–¹æ¡ˆï¼š
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰§è¡Œæ—¥å¿—åˆ›å»ºæˆåŠŸ
- [ ] å¯ä»¥è¿½è¸ªæ¯æ—¥è¿›åº¦

### 2.3 é˜¶æ®µ 0 éªŒè¯

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
pnpm test

# æäº¤å‡†å¤‡å·¥ä½œ
git add .
git commit -m "chore: prepare for shared directory refactoring"
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] å‡†å¤‡å·¥ä½œå·²æäº¤
- [ ] å¯ä»¥å¼€å§‹é˜¶æ®µ 1

---

## ä¸‰ã€é˜¶æ®µ 1ï¼šç±»å‹ä¸é…ç½®åˆ†ç¦»ï¼ˆç¬¬ 2-4 å¤©ï¼‰

**ç›®æ ‡**ï¼šå°† `shared/types` ä¸­çš„é…ç½®æ•°æ®å’Œå·¥å…·å‡½æ•°åˆ†ç¦»åˆ°ç›¸åº”æ¨¡å—

### 3.1 ç¬¬ 2 å¤©ï¼šåˆ†ç¦» mode.ts å’Œ tool.ts

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 1.1ï¼šåˆ†ç¦» types/mode.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 1.1.1**ï¼šåˆ›å»º `src/core/modes/default-modes.ts`ï¼ˆ30 åˆ†é’Ÿï¼‰

```typescript
import type { ModeConfig } from "@shared/types"

export const DEFAULT_MODES: readonly ModeConfig[] = [
  {
    slug: "architect",
    name: "ğŸ—ï¸ Architect",
    roleDefinition: "You are Roo, an experienced technical leader who is inquisitive and an excellent planner...",
    whenToUse: "Use this mode when you need to plan, design, or strategize before implementation...",
    description: "Plan and design before implementation",
    groups: ["read", ["edit", { fileRegex: "\\.md$", description: "Markdown files only" }], "browser", "mcp"],
    customInstructions: "1. Do some information gathering...",
  },
  // ... å…¶ä»– mode é…ç½®
] as const
```

**æ­¥éª¤ 1.1.2**ï¼šä¿®æ”¹ `shared/types/mode.ts`ï¼ˆ30 åˆ†é’Ÿï¼‰

ç§»é™¤ `DEFAULT_MODES` å¸¸é‡ï¼Œåªä¿ç•™ç±»å‹å®šä¹‰ã€‚

**æ­¥éª¤ 1.1.3**ï¼šæ›´æ–° `shared/modes.ts`ï¼ˆ1 å°æ—¶ï¼‰

ä¿®æ”¹å¯¼å…¥è·¯å¾„ï¼š

```typescript
// ä»
import { DEFAULT_MODES } from "@shared/types"

// æ”¹ä¸º
import { DEFAULT_MODES } from "../core/modes/default-modes"
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] `default-modes.ts` åˆ›å»ºæˆåŠŸ
- [ ] `types/mode.ts` åªåŒ…å«ç±»å‹å®šä¹‰
- [ ] `modes.ts` å¯¼å…¥è·¯å¾„æ›´æ–°æˆåŠŸ
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 1.2ï¼šåˆ†ç¦» types/tool.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 1.2.1**ï¼šåˆ›å»º `src/core/tools/tool-utils.ts`ï¼ˆ30 åˆ†é’Ÿï¼‰

```typescript
import { TOOL_PROTOCOL, ToolProtocol } from "@shared/types"

export function isNativeProtocol(protocol: ToolProtocol): boolean {
  return protocol === TOOL_PROTOCOL.NATIVE
}

export function getEffectiveProtocol(toolProtocol?: ToolProtocol): ToolProtocol {
  return toolProtocol || TOOL_PROTOCOL.XML
}
```

**æ­¥éª¤ 1.2.2**ï¼šä¿®æ”¹ `shared/types/tool.ts`ï¼ˆ30 åˆ†é’Ÿï¼‰

ç§»é™¤ `isNativeProtocol` å’Œ `getEffectiveProtocol` å‡½æ•°ã€‚

**æ­¥éª¤ 1.2.3**ï¼šæ›´æ–°æ‰€æœ‰ä½¿ç”¨è¿™äº›å‡½æ•°çš„æ–‡ä»¶ï¼ˆ1 å°æ—¶ï¼‰

ä½¿ç”¨å…¨å±€æœç´¢æ›¿æ¢ï¼š

```bash
# æœç´¢æ‰€æœ‰ä½¿ç”¨ isNativeProtocol çš„æ–‡ä»¶
grep -r "isNativeProtocol" src/

# é€ä¸ªæ›´æ–°å¯¼å…¥è·¯å¾„
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] `tool-utils.ts` åˆ›å»ºæˆåŠŸ
- [ ] `types/tool.ts` åªåŒ…å«ç±»å‹å®šä¹‰
- [ ] æ‰€æœ‰ä½¿ç”¨è¿™äº›å‡½æ•°çš„æ–‡ä»¶å·²æ›´æ–°
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 1.3ï¼šè¿è¡Œæµ‹è¯•å’Œä¿®å¤ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# å¦‚æœæœ‰å¤±è´¥ï¼Œä¿®å¤é—®é¢˜
# é‡æ–°è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡

### 3.2 ç¬¬ 3 å¤©ï¼šåˆ†ç¦» codebase-index.ts å’Œ global-settings.ts

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 1.4ï¼šåˆ†ç¦» types/codebase-index.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 1.4.1**ï¼šåˆ›å»º `src/services/code-index/config.ts`ï¼ˆ1 å°æ—¶ï¼‰

```typescript
export const CODEBASE_INDEX_DEFAULTS = {
  MIN_SEARCH_RESULTS: 10,
  MAX_SEARCH_RESULTS: 200,
  DEFAULT_SEARCH_RESULTS: 50,
  SEARCH_RESULTS_STEP: 10,
  MIN_SEARCH_SCORE: 0,
  MAX_SEARCH_SCORE: 1,
  DEFAULT_SEARCH_MIN_SCORE: 0.4,
  SEARCH_SCORE_STEP: 0.05,
} as const

export const VECTOR_STORAGE_PRESETS: Record<string, VectorStorageConfig> = {
  // ... é…ç½®æ•°æ®
}

export const DEFAULT_VECTOR_STORAGE_CONFIG: VectorStorageConfig = {
  // ... é…ç½®æ•°æ®
}
```

**æ­¥éª¤ 1.4.2**ï¼šä¿®æ”¹ `shared/types/codebase-index.ts`ï¼ˆ1 å°æ—¶ï¼‰

ç§»é™¤é…ç½®æ•°æ®ï¼Œåªä¿ç•™ç±»å‹å®šä¹‰ã€‚

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] `config.ts` åˆ›å»ºæˆåŠŸ
- [ ] `types/codebase-index.ts` åªåŒ…å«ç±»å‹å®šä¹‰
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 1.5ï¼šåˆ†ç¦» types/global-settings.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 1.5.1**ï¼šåˆ›å»º `src/core/constants/default-values.ts`ï¼ˆ30 åˆ†é’Ÿï¼‰

```typescript
export const DEFAULT_WRITE_DELAY_MS = 1000

export const DEFAULT_TERMINAL_OUTPUT_CHARACTER_LIMIT = 50_000

export const MIN_CHECKPOINT_TIMEOUT_SECONDS = 10

export const MAX_CHECKPOINT_TIMEOUT_SECONDS = 60

export const DEFAULT_CHECKPOINT_TIMEOUT_SECONDS = 15

export const DEFAULT_CONSECUTIVE_MISTAKE_LIMIT = 3
```

**æ­¥éª¤ 1.5.2**ï¼šä¿®æ”¹ `shared/types/global-settings.ts`ï¼ˆ30 åˆ†é’Ÿï¼‰

ç§»é™¤å¸¸é‡å®šä¹‰ï¼Œåªä¿ç•™ç±»å‹å®šä¹‰ã€‚

**æ­¥éª¤ 1.5.3**ï¼šæ›´æ–°æ‰€æœ‰ä½¿ç”¨è¿™äº›å¸¸é‡çš„æ–‡ä»¶ï¼ˆ1 å°æ—¶ï¼‰

ä½¿ç”¨å…¨å±€æœç´¢æ›¿æ¢ï¼š

```bash
# æœç´¢æ‰€æœ‰ä½¿ç”¨ DEFAULT_WRITE_DELAY_MS çš„æ–‡ä»¶
grep -r "DEFAULT_WRITE_DELAY_MS" src/

# é€ä¸ªæ›´æ–°å¯¼å…¥è·¯å¾„
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] `default-values.ts` åˆ›å»ºæˆåŠŸ
- [ ] `types/global-settings.ts` åªåŒ…å«ç±»å‹å®šä¹‰
- [ ] æ‰€æœ‰ä½¿ç”¨è¿™äº›å¸¸é‡çš„æ–‡ä»¶å·²æ›´æ–°
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 1.6ï¼šåˆ†ç¦» types/message.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 1.6.1**ï¼šåˆ›å»º `src/core/task/managers/messaging/message-utils.ts`ï¼ˆ1 å°æ—¶ï¼‰

```typescript
import type { ClineAsk, BlockingAsk, NonBlockingAsk, MutableAsk } from "@shared/types"

export const blockingAsks = [
  "followup",
  "command",
  "tool",
  "browser_action_launch",
  "use_mcp_server",
] as const satisfies readonly ClineAsk[]

export type BlockingAsk = (typeof blockingAsks)[number]

export function isBlockingAsk(ask: ClineAsk): ask is BlockingAsk {
  return (blockingAsks as readonly ClineAsk[]).includes(ask)
}

// ... å…¶ä»–å·¥å…·å‡½æ•°
```

**æ­¥éª¤ 1.6.2**ï¼šä¿®æ”¹ `shared/types/message.ts`ï¼ˆ1 å°æ—¶ï¼‰

ç§»é™¤å·¥å…·å‡½æ•°ï¼Œåªä¿ç•™ç±»å‹å®šä¹‰ã€‚

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] `message-utils.ts` åˆ›å»ºæˆåŠŸ
- [ ] `types/message.ts` åªåŒ…å«ç±»å‹å®šä¹‰
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 1.7ï¼šè¿è¡Œæµ‹è¯•å’Œä¿®å¤ï¼ˆ2 å°æ—¶ï¼‰

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# ä¿®å¤é—®é¢˜
# é‡æ–°è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡

### 3.3 ç¬¬ 4 å¤©ï¼šé˜¶æ®µ 1 éªŒè¯å’Œæäº¤

#### å…¨å¤©ä»»åŠ¡ï¼ˆ8 å°æ—¶ï¼‰

##### ä»»åŠ¡ 1.8ï¼šå®Œæ•´éªŒè¯ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint

# æ„å»ºé¡¹ç›®
pnpm build

# æ‰‹åŠ¨æµ‹è¯•å…³é”®åŠŸèƒ½
# 1. å¯åŠ¨ VS Code æ‰©å±•
# 2. æµ‹è¯• mode åˆ‡æ¢
# 3. æµ‹è¯• tool ä½¿ç”¨
# 4. æµ‹è¯• API è°ƒç”¨
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡
- [ ] æ„å»ºæˆåŠŸ
- [ ] æ‰‹åŠ¨æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 1.9ï¼šæäº¤ä»£ç ï¼ˆ2 å°æ—¶ï¼‰

```bash
# æ·»åŠ æ‰€æœ‰æ›´æ”¹
git add .

# æäº¤ä»£ç 
git commit -m "feat: separate types from configurations in shared/types

- Move DEFAULT_MODES to src/core/modes/default-modes.ts
- Move tool utility functions to src/core/tools/tool-utils.ts
- Move codebase-index configs to src/services/code-index/config.ts
- Move global constants to src/core/constants/default-values.ts
- Move message utility functions to src/core/task/managers/messaging/message-utils.ts

This ensures shared/types only contains pure type definitions,
avoiding circular dependencies."

# æ¨é€åˆ°è¿œç¨‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
git push origin backup-before-refactoring
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] ä»£ç å·²æäº¤
- [ ] æäº¤ä¿¡æ¯æ¸…æ™°
- [ ] å¯ä»¥å¼€å§‹é˜¶æ®µ 2

##### ä»»åŠ¡ 1.10ï¼šæ›´æ–°æ‰§è¡Œæ—¥å¿—ï¼ˆ2 å°æ—¶ï¼‰

åœ¨ `refactoring-log.md` ä¸­è®°å½•é˜¶æ®µ 1 çš„å®Œæˆæƒ…å†µã€‚

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰§è¡Œæ—¥å¿—å·²æ›´æ–°
- [ ] å¯ä»¥è¿½è¸ªè¿›åº¦

---

## å››ã€é˜¶æ®µ 2ï¼šé«˜ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼ˆç¬¬ 5-7 å¤©ï¼‰

**ç›®æ ‡**ï¼šè¿ç§»é«˜ä¼˜å…ˆçº§çš„ç‰¹å®šæ¨¡å—åŠŸèƒ½åˆ°ç›¸åº”ä½ç½®

### 4.1 ç¬¬ 5 å¤©ï¼šè¿ç§» vsCodeSelectorUtils.ts å’Œ api.ts

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 2.1ï¼šè¿ç§» vsCodeSelectorUtils.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 2.1.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/vsCodeSelectorUtils.ts src/utils/vsCodeSelectorUtils.ts
```

**æ­¥éª¤ 2.1.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/vsCodeSelectorUtils` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { stringifyVsCodeLmModelSelector } from "@shared/vsCodeSelectorUtils"

// æ”¹ä¸º
import { stringifyVsCodeLmModelSelector } from "@utils/vsCodeSelectorUtils"
```

**æ­¥éª¤ 2.1.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/vsCodeSelectorUtils.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 2.2ï¼šè¿ç§» api.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 2.2.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/api.ts src/api/api-utils.ts
```

**æ­¥éª¤ 2.2.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/api` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { shouldUseReasoningBudget, getModelMaxOutputTokens } from "@shared/api"

// æ”¹ä¸º
import { shouldUseReasoningBudget, getModelMaxOutputTokens } from "@api/api-utils"
```

**æ­¥éª¤ 2.2.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/api.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 2.3ï¼šè¿è¡Œæµ‹è¯•å’Œä¿®å¤ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# ä¿®å¤é—®é¢˜
# é‡æ–°è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡

### 4.2 ç¬¬ 6 å¤©ï¼šè¿ç§» modes.ts å’Œ mcp.ts

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 2.4ï¼šè¿ç§» modes.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 2.4.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/modes.ts src/core/modes/mode-utils.ts
```

**æ­¥éª¤ 2.4.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/modes` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { modes, defaultModeSlug, defaultPrompts } from "@shared/modes"

// æ”¹ä¸º
import { modes, defaultModeSlug, defaultPrompts } from "@core/modes/mode-utils"
```

**æ­¥éª¤ 2.4.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/modes.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 2.5ï¼šè¿ç§» mcp.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 2.5.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/mcp.ts src/services/mcp/mcp-types.ts
```

**æ­¥éª¤ 2.5.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/mcp` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { McpServer, McpTool, McpResource } from "@shared/mcp"

// æ”¹ä¸º
import { McpServer, McpTool, McpResource } from "@services/mcp/mcp-types"
```

**æ­¥éª¤ 2.5.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/mcp.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 2.6ï¼šè¿è¡Œæµ‹è¯•å’Œä¿®å¤ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# ä¿®å¤é—®é¢˜
# é‡æ–°è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡

### 4.3 ç¬¬ 7 å¤©ï¼šè¿ç§» tools.ts å’Œ checkExistApiConfig.tsï¼Œé˜¶æ®µ 2 éªŒè¯

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 2.7ï¼šè¿ç§» tools.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 2.7.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/tools.ts src/core/tools/tool-config.ts
```

**æ­¥éª¤ 2.7.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/tools` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { TOOL_GROUPS, ALWAYS_AVAILABLE_TOOLS } from "@shared/tools"

// æ”¹ä¸º
import { TOOL_GROUPS, ALWAYS_AVAILABLE_TOOLS } from "@core/tools/tool-config"
```

**æ­¥éª¤ 2.7.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/tools.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 2.8ï¼šè¿ç§» checkExistApiConfig.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 2.8.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/checkExistApiConfig.ts src/core/providers/config-utils.ts
```

**æ­¥éª¤ 2.8.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/checkExistApiConfig` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { checkExistKey } from "@shared/checkExistApiConfig"

// æ”¹ä¸º
import { checkExistKey } from "@core/providers/config-utils"
```

**æ­¥éª¤ 2.8.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/checkExistApiConfig.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 2.9ï¼šå®Œæ•´éªŒè¯ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint

# æ„å»ºé¡¹ç›®
pnpm build

# æ‰‹åŠ¨æµ‹è¯•å…³é”®åŠŸèƒ½
# 1. å¯åŠ¨ VS Code æ‰©å±•
# 2. æµ‹è¯• mode åˆ‡æ¢
# 3. æµ‹è¯• tool ä½¿ç”¨
# 4. æµ‹è¯• MCP åŠŸèƒ½
# 5. æµ‹è¯• API é…ç½®
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡
- [ ] æ„å»ºæˆåŠŸ
- [ ] æ‰‹åŠ¨æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 2.10ï¼šæäº¤ä»£ç ï¼ˆ2 å°æ—¶ï¼‰

```bash
# æ·»åŠ æ‰€æœ‰æ›´æ”¹
git add .

# æäº¤ä»£ç 
git commit -m "refactor: migrate high-priority modules from shared to core

- Move vsCodeSelectorUtils.ts to src/utils/vsCodeSelectorUtils.ts
- Move api.ts to src/api/api-utils.ts
- Move modes.ts to src/core/modes/mode-utils.ts
- Move mcp.ts to src/services/mcp/mcp-types.ts
- Move tools.ts to src/core/tools/tool-config.ts
- Move checkExistApiConfig.ts to src/core/providers/config-utils.ts

This reduces cross-layer dependencies and improves module organization."

# æ¨é€åˆ°è¿œç¨‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
git push origin backup-before-refactoring
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] ä»£ç å·²æäº¤
- [ ] æäº¤ä¿¡æ¯æ¸…æ™°
- [ ] å¯ä»¥å¼€å§‹é˜¶æ®µ 3

##### ä»»åŠ¡ 2.11ï¼šæ›´æ–°æ‰§è¡Œæ—¥å¿—ï¼ˆ2 å°æ—¶ï¼‰

åœ¨ `refactoring-log.md` ä¸­è®°å½•é˜¶æ®µ 2 çš„å®Œæˆæƒ…å†µã€‚

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰§è¡Œæ—¥å¿—å·²æ›´æ–°
- [ ] å¯ä»¥è¿½è¸ªè¿›åº¦

---

## äº”ã€é˜¶æ®µ 3ï¼šä¸­ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼ˆç¬¬ 8-10 å¤©ï¼‰

**ç›®æ ‡**ï¼šè¿ç§»ä¸­ä¼˜å…ˆçº§çš„ç‰¹å®šæ¨¡å—åŠŸèƒ½åˆ°ç›¸åº”ä½ç½®

### 5.1 ç¬¬ 8 å¤©ï¼šè¿ç§» combineApiRequests.ts å’Œ combineCommandSequences.ts

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 3.1ï¼šè¿ç§» combineApiRequests.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 3.1.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/combineApiRequests.ts src/core/task/managers/api/message-utils.ts
```

**æ­¥éª¤ 3.1.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/combineApiRequests` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { combineApiRequests } from "@shared/combineApiRequests"

// æ”¹ä¸º
import { combineApiRequests } from "@core/task/managers/api/message-utils"
```

**æ­¥éª¤ 3.1.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/combineApiRequests.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 3.2ï¼šè¿ç§» combineCommandSequences.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 3.2.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/combineCommandSequences.ts src/core/task/managers/messaging/message-utils.ts
```

**æ­¥éª¤ 3.2.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/combineCommandSequences` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { combineCommandSequences } from "@shared/combineCommandSequences"

// æ”¹ä¸º
import { combineCommandSequences } from "@core/task/managers/messaging/message-utils"
```

**æ­¥éª¤ 3.2.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/combineCommandSequences.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 3.3ï¼šè¿è¡Œæµ‹è¯•å’Œä¿®å¤ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# ä¿®å¤é—®é¢˜
# é‡æ–°è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡

### 5.2 ç¬¬ 9 å¤©ï¼šè¿ç§» getApiMetrics.ts å’Œ support-prompt.ts

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 3.4ï¼šè¿ç§» getApiMetrics.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 3.4.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/getApiMetrics.ts src/core/task/managers/monitoring/metrics-utils.ts
```

**æ­¥éª¤ 3.4.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/getApiMetrics` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { getApiMetrics, hasTokenUsageChanged, hasToolUsageChanged } from "@shared/getApiMetrics"

// æ”¹ä¸º
import { getApiMetrics, hasTokenUsageChanged, hasToolUsageChanged } from "@core/task/managers/monitoring/metrics-utils"
```

**æ­¥éª¤ 3.4.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/getApiMetrics.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 3.5ï¼šè¿ç§» support-prompt.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 3.5.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/support-prompt.ts src/core/prompts/support-prompt.ts
```

**æ­¥éª¤ 3.5.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/support-prompt` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { supportPrompt, SupportPromptType } from "@shared/support-prompt"

// æ”¹ä¸º
import { supportPrompt, SupportPromptType } from "@core/prompts/support-prompt"
```

**æ­¥éª¤ 3.5.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/support-prompt.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 3.6ï¼šè¿è¡Œæµ‹è¯•å’Œä¿®å¤ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# ä¿®å¤é—®é¢˜
# é‡æ–°è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡

### 5.3 ç¬¬ 10 å¤©ï¼šè¿ç§» embeddingModels.ts å’Œ context-mentions.tsï¼Œé˜¶æ®µ 3 éªŒè¯

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 3.7ï¼šè¿ç§» embeddingModels.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 3.7.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/embeddingModels.ts src/services/code-index/embedding-models.ts
```

**æ­¥éª¤ 3.7.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/embeddingModels` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { getModelDimension, getModelScoreThreshold } from "@shared/embeddingModels"

// æ”¹ä¸º
import { getModelDimension, getModelScoreThreshold } from "@services/code-index/embedding-models"
```

**æ­¥éª¤ 3.7.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/embeddingModels.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 3.8ï¼šè¿ç§» context-mentions.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 3.8.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/context-mentions.ts src/utils/context-mentions.ts
```

**æ­¥éª¤ 3.8.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/context-mentions` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { mentionRegex, mentionRegexGlobal } from "@shared/context-mentions"

// æ”¹ä¸º
import { mentionRegex, mentionRegexGlobal } from "@utils/context-mentions"
```

**æ­¥éª¤ 3.8.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/context-mentions.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 3.9ï¼šå®Œæ•´éªŒè¯ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint

# æ„å»ºé¡¹ç›®
pnpm build

# æ‰‹åŠ¨æµ‹è¯•å…³é”®åŠŸèƒ½
# 1. å¯åŠ¨ VS Code æ‰©å±•
# 2. æµ‹è¯• API æŒ‡æ ‡
# 3. æµ‹è¯•æ”¯æŒæç¤ºè¯
# 4. æµ‹è¯•ä»£ç ç´¢å¼•
# 5. æµ‹è¯•ä¸Šä¸‹æ–‡æåŠ
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡
- [ ] æ„å»ºæˆåŠŸ
- [ ] æ‰‹åŠ¨æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 3.10ï¼šæäº¤ä»£ç ï¼ˆ2 å°æ—¶ï¼‰

```bash
# æ·»åŠ æ‰€æœ‰æ›´æ”¹
git add .

# æäº¤ä»£ç 
git commit -m "refactor: migrate medium-priority modules from shared

- Move combineApiRequests.ts to src/core/task/managers/api/message-utils.ts
- Move combineCommandSequences.ts to src/core/task/managers/messaging/message-utils.ts
- Move getApiMetrics.ts to src/core/task/managers/monitoring/metrics-utils.ts
- Move support-prompt.ts to src/core/prompts/support-prompt.ts
- Move embeddingModels.ts to src/services/code-index/embedding-models.ts
- Move context-mentions.ts to src/utils/context-mentions.ts

This further reduces cross-layer dependencies and improves module organization."

# æ¨é€åˆ°è¿œç¨‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
git push origin backup-before-refactoring
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] ä»£ç å·²æäº¤
- [ ] æäº¤ä¿¡æ¯æ¸…æ™°
- [ ] å¯ä»¥å¼€å§‹é˜¶æ®µ 4

##### ä»»åŠ¡ 3.11ï¼šæ›´æ–°æ‰§è¡Œæ—¥å¿—ï¼ˆ2 å°æ—¶ï¼‰

åœ¨ `refactoring-log.md` ä¸­è®°å½•é˜¶æ®µ 3 çš„å®Œæˆæƒ…å†µã€‚

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰§è¡Œæ—¥å¿—å·²æ›´æ–°
- [ ] å¯ä»¥è¿½è¸ªè¿›åº¦

---

## å…­ã€é˜¶æ®µ 4ï¼šä½ä¼˜å…ˆçº§æ¨¡å—è¿ç§»ï¼ˆç¬¬ 11-12 å¤©ï¼Œå¯é€‰ï¼‰

**ç›®æ ‡**ï¼šè¿ç§»ä½ä¼˜å…ˆçº§çš„ç‰¹å®šæ¨¡å—åŠŸèƒ½åˆ°ç›¸åº”ä½ç½®ï¼ˆå¯é€‰ï¼‰

### 6.1 ç¬¬ 11 å¤©ï¼šè¿ç§» experiments.ts å’Œ cost.ts

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 4.1ï¼šè¿ç§» experiments.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 4.1.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/experiments.ts src/core/experiments/experiment-utils.ts
```

**æ­¥éª¤ 4.1.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/experiments` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { EXPERIMENT_IDS, experimentConfigsMap, experimentDefault } from "@shared/experiments"

// æ”¹ä¸º
import { EXPERIMENT_IDS, experimentConfigsMap, experimentDefault } from "@core/experiments/experiment-utils"
```

**æ­¥éª¤ 4.1.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/experiments.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 4.2ï¼šè¿ç§» cost.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 4.2.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/cost.ts src/api/cost-utils.ts
```

**æ­¥éª¤ 4.2.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/cost` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { calculateApiCostAnthropic, calculateApiCostOpenAI } from "@shared/cost"

// æ”¹ä¸º
import { calculateApiCostAnthropic, calculateApiCostOpenAI } from "@api/cost-utils"
```

**æ­¥éª¤ 4.2.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/cost.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 4.3ï¼šè¿è¡Œæµ‹è¯•å’Œä¿®å¤ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# ä¿®å¤é—®é¢˜
# é‡æ–°è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡

### 6.2 ç¬¬ 12 å¤©ï¼šè¿ç§» browserUtils.tsã€parse-command.ts å’Œ todo.ts

#### ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 4.4ï¼šè¿ç§» browserUtils.tsï¼ˆ1.5 å°æ—¶ï¼‰

**æ­¥éª¤ 4.4.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/browserUtils.ts src/core/webview/browser-utils.ts
```

**æ­¥éª¤ 4.4.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/browserUtils` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { scaleCoordinate, prettyKey } from "@shared/browserUtils"

// æ”¹ä¸º
import { scaleCoordinate, prettyKey } from "@core/webview/browser-utils"
```

**æ­¥éª¤ 4.4.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/browserUtils.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 4.5ï¼šè¿ç§» parse-command.tsï¼ˆ1.5 å°æ—¶ï¼‰

**æ­¥éª¤ 4.5.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/parse-command.ts src/core/tools/command-parser.ts
```

**æ­¥éª¤ 4.5.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/parse-command` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { parseCommand } from "@shared/parse-command"

// æ”¹ä¸º
import { parseCommand } from "@core/tools/command-parser"
```

**æ­¥éª¤ 4.5.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/parse-command.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

#### ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

##### ä»»åŠ¡ 4.6ï¼šè¿ç§» todo.tsï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 4.6.1**ï¼šç§»åŠ¨æ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
mv src/shared/todo.ts src/core/task/managers/todo-utils.ts
```

**æ­¥éª¤ 4.6.2**ï¼šæ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆ1 å°æ—¶ï¼‰

æœç´¢æ‰€æœ‰ä½¿ç”¨ `@shared/todo` çš„æ–‡ä»¶å¹¶æ›´æ–°ï¼š

```typescript
// ä»
import { getTodosFromMessages } from "@shared/todo"

// æ”¹ä¸º
import { getTodosFromMessages } from "@core/task/managers/todo-utils"
```

**æ­¥éª¤ 4.6.3**ï¼šåˆ é™¤åŸæ–‡ä»¶ï¼ˆ30 åˆ†é’Ÿï¼‰

```bash
rm src/shared/todo.ts
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶ç§»åŠ¨æˆåŠŸ
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] åŸæ–‡ä»¶å·²åˆ é™¤
- [ ] ç›¸å…³æµ‹è¯•é€šè¿‡

##### ä»»åŠ¡ 4.7ï¼šè¿è¡Œæµ‹è¯•å’Œä¿®å¤ï¼ˆ2 å°æ—¶ï¼‰

```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# ä¿®å¤é—®é¢˜
# é‡æ–°è¿è¡Œæµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡

---

## ä¸ƒã€é˜¶æ®µ 5ï¼šæ¸…ç†ä¸ä¼˜åŒ–ï¼ˆç¬¬ 13 å¤©ï¼‰

**ç›®æ ‡**ï¼šæ¸…ç†æ®‹ç•™æ–‡ä»¶ï¼Œä¼˜åŒ–å¯¼å…¥è·¯å¾„ï¼Œæ›´æ–°æ–‡æ¡£

### 7.1 ä¸Šåˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

#### ä»»åŠ¡ 5.1ï¼šæ¸…ç†æµ‹è¯•æ–‡ä»¶ï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 5.1.1**ï¼šç§»åŠ¨æµ‹è¯•æ–‡ä»¶ï¼ˆ1.5 å°æ—¶ï¼‰

```bash
# ç§»åŠ¨ shared/__tests__ ä¸­çš„æµ‹è¯•æ–‡ä»¶åˆ°ç›¸åº”ä½ç½®
mv src/shared/__tests__/modes.spec.ts src/core/modes/__tests__/mode-utils.spec.ts
mv src/shared/__tests__/api.spec.ts src/api/__tests__/api-utils.spec.ts
mv src/shared/__tests__/getApiMetrics.spec.ts src/core/task/managers/monitoring/__tests__/metrics-utils.spec.ts
mv src/shared/__tests__/combineApiRequests.spec.ts src/core/task/managers/api/__tests__/message-utils.spec.ts
mv src/shared/__tests__/combineCommandSequences.spec.ts src/core/task/managers/messaging/__tests__/message-utils.spec.ts
mv src/shared/__tests__/experiments.spec.ts src/core/experiments/__tests__/experiment-utils.spec.ts
mv src/shared/__tests__/support-prompts.spec.ts src/core/prompts/__tests__/support-prompt.spec.ts
mv src/shared/__tests__/language.spec.ts src/shared/__tests__/language.spec.ts
mv src/shared/__tests__/vsCodeSelectorUtils.spec.ts src/utils/__tests__/vsCodeSelectorUtils.spec.ts
mv src/shared/__tests__/checkExistApiConfig.spec.ts src/core/providers/__tests__/config-utils.spec.ts
mv src/shared/__tests__/context-mentions.spec.ts src/utils/__tests__/context-mentions.spec.ts
```

**æ­¥éª¤ 5.1.2**ï¼šæ›´æ–°æµ‹è¯•æ–‡ä»¶ä¸­çš„å¯¼å…¥è·¯å¾„ï¼ˆ30 åˆ†é’Ÿï¼‰

é€ä¸ªæ›´æ–°ç§»åŠ¨çš„æµ‹è¯•æ–‡ä»¶ä¸­çš„å¯¼å…¥è·¯å¾„ã€‚

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•æ–‡ä»¶å·²ç§»åŠ¨
- [ ] å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] æµ‹è¯•å¯ä»¥è¿è¡Œ

#### ä»»åŠ¡ 5.2ï¼šåˆ é™¤åŸæµ‹è¯•ç›®å½•ï¼ˆ2 å°æ—¶ï¼‰

```bash
# åˆ é™¤åŸæµ‹è¯•ç›®å½•
rm -rf src/shared/__tests__

# éªŒè¯åˆ é™¤æˆåŠŸ
ls -la src/shared/
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] åŸæµ‹è¯•ç›®å½•å·²åˆ é™¤
- [ ] shared ç›®å½•ç»“æ„æ¸…æ™°

### 7.2 ä¸‹åˆä»»åŠ¡ï¼ˆ4 å°æ—¶ï¼‰

#### ä»»åŠ¡ 5.3ï¼šæ›´æ–° shared/index.tsï¼ˆ2 å°æ—¶ï¼‰

æ·»åŠ é‡æ–°å¯¼å‡ºï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰ï¼š

```typescript
// src/shared/index.ts
export * from "./types"
export * from "./array"
export * from "./safeJsonParse"
export * from "./language"
export * from "./globalFileNames"

// é‡æ–°å¯¼å‡ºç§»åŠ¨åçš„æ¨¡å—ï¼Œä¿æŒå‘åå…¼å®¹
export { modes, defaultModeSlug, defaultPrompts } from "../core/modes/mode-utils"
export { TOOL_GROUPS, ALWAYS_AVAILABLE_TOOLS } from "../core/tools/tool-config"
export { DEFAULT_MODES } from "../core/modes/default-modes"
export { checkExistKey } from "../core/providers/config-utils"
export { combineApiRequests } from "../core/task/managers/api/message-utils"
export { combineCommandSequences } from "../core/task/managers/messaging/message-utils"
export { getApiMetrics, hasTokenUsageChanged, hasToolUsageChanged } from "../core/task/managers/monitoring/metrics-utils"
export { supportPrompt, SupportPromptType } from "../core/prompts/support-prompt"
export { getModelDimension, getModelScoreThreshold } from "../services/code-index/embedding-models"
export { EXPERIMENT_IDS, experimentConfigsMap, experimentDefault } from "../core/experiments/experiment-utils"
export { calculateApiCostAnthropic, calculateApiCostOpenAI } from "@api/cost-utils"
export { scaleCoordinate, prettyKey } from "../core/webview/browser-utils"
export { parseCommand } from "../core/tools/command-parser"
export { getTodosFromMessages } from "../core/task/managers/todo-utils"
export { mentionRegex, mentionRegexGlobal } from "../utils/context-mentions"
export { stringifyVsCodeLmModelSelector } from "../utils/vsCodeSelectorUtils"
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] é‡æ–°å¯¼å‡ºå·²æ·»åŠ 
- [ ] å‘åå…¼å®¹æ€§ä¿æŒ
- [ ] å¯¼å…¥è·¯å¾„æ­£ç¡®

#### ä»»åŠ¡ 5.4ï¼šæ›´æ–°æ–‡æ¡£ï¼ˆ2 å°æ—¶ï¼‰

**æ­¥éª¤ 5.4.1**ï¼šæ›´æ–° READMEï¼ˆ1 å°æ—¶ï¼‰

åœ¨é¡¹ç›® README ä¸­æ›´æ–°ç›®å½•ç»“æ„è¯´æ˜ã€‚

**æ­¥éª¤ 5.4.2**ï¼šåˆ›å»ºè¿ç§»æŒ‡å—ï¼ˆ1 å°æ—¶ï¼‰

åˆ›å»º `docs/refactoring/shared-refactoring-guide.md`ã€‚

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] README å·²æ›´æ–°
- [ ] è¿ç§»æŒ‡å—å·²åˆ›å»º
- [ ] æ–‡æ¡£æ¸…æ™°æ˜“æ‡‚

### 7.3 é˜¶æ®µ 5 éªŒè¯ï¼ˆ4 å°æ—¶ï¼‰

#### ä»»åŠ¡ 5.5ï¼šå®Œæ•´éªŒè¯ï¼ˆ4 å°æ—¶ï¼‰

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œç±»å‹æ£€æŸ¥
pnpm check-types

# è¿è¡Œ lint
pnpm lint

# æ„å»ºé¡¹ç›®
pnpm build

# æ‰‹åŠ¨æµ‹è¯•æ‰€æœ‰å…³é”®åŠŸèƒ½
# 1. å¯åŠ¨ VS Code æ‰©å±•
# 2. æµ‹è¯•æ‰€æœ‰ mode
# 3. æµ‹è¯•æ‰€æœ‰ tool
# 4. æµ‹è¯• MCP åŠŸèƒ½
# 5. æµ‹è¯• API é…ç½®
# 6. æµ‹è¯•ä»£ç ç´¢å¼•
# 7. æµ‹è¯•å®éªŒåŠŸèƒ½
# 8. æµ‹è¯•æµè§ˆå™¨åŠŸèƒ½
# 9. æµ‹è¯•å‘½ä»¤è§£æ
# 10. æµ‹è¯• todo åŠŸèƒ½
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] lint é€šè¿‡
- [ ] æ„å»ºæˆåŠŸ
- [ ] æ‰€æœ‰æ‰‹åŠ¨æµ‹è¯•é€šè¿‡

#### ä»»åŠ¡ 5.6ï¼šæäº¤ä»£ç ï¼ˆ2 å°æ—¶ï¼‰

```bash
# æ·»åŠ æ‰€æœ‰æ›´æ”¹
git add .

# æäº¤ä»£ç 
git commit -m "refactor: complete shared directory refactoring

- Move all test files to appropriate locations
- Update shared/index.ts with re-exports for backward compatibility
- Update README and documentation
- Clean up shared/__tests__ directory

This completes the shared directory refactoring, reducing cross-layer
dependencies and improving module organization."

# æ¨é€åˆ°è¿œç¨‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
git push origin backup-before-refactoring

# åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
git checkout main
git merge backup-before-refactoring
git push origin main
```

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] ä»£ç å·²æäº¤
- [ ] æäº¤ä¿¡æ¯æ¸…æ™°
- [ ] å·²åˆå¹¶åˆ°ä¸»åˆ†æ”¯

#### ä»»åŠ¡ 5.7ï¼šæ›´æ–°æ‰§è¡Œæ—¥å¿—ï¼ˆ2 å°æ—¶ï¼‰

åœ¨ `refactoring-log.md` ä¸­è®°å½•é˜¶æ®µ 5 çš„å®Œæˆæƒ…å†µå’Œæ€»ç»“ã€‚

**éªŒè¯æ ‡å‡†**ï¼š
- [ ] æ‰§è¡Œæ—¥å¿—å·²æ›´æ–°
- [ ] é‡æ„å®Œæˆæ€»ç»“å·²è®°å½•

---

## å…«ã€æ¯æ—¥æ‰§è¡Œæ£€æŸ¥æ¸…å•

### 8.1 æ¯æ—¥å¼€å§‹å‰

- [ ] æ£€æŸ¥å½“å‰é˜¶æ®µå’Œä»»åŠ¡
- [ ] ç¡®è®¤æ˜¨æ—¥å·¥ä½œå·²å®Œæˆ
- [ ] æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—ï¼Œäº†è§£è¿›åº¦
- [ ] å‡†å¤‡ä»Šæ—¥å·¥ä½œè®¡åˆ’

### 8.2 æ¯æ—¥å·¥ä½œä¸­

- [ ] æŒ‰ç…§ä»»åŠ¡æ¸…å•æ‰§è¡Œ
- [ ] æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡ï¼ŒéªŒè¯ä¸€æ¬¡
- [ ] é‡åˆ°é—®é¢˜åŠæ—¶è®°å½•
- [ ] é‡åˆ°é—®é¢˜åŠæ—¶è§£å†³

### 8.3 æ¯æ—¥å·¥ä½œç»“æŸå‰

- [ ] è¿è¡Œæµ‹è¯•
- [ ] è¿è¡Œç±»å‹æ£€æŸ¥
- [ ] è¿è¡Œ lint
- [ ] æäº¤ä»£ç ï¼ˆå¦‚æœå®Œæˆé˜¶æ®µï¼‰
- [ ] æ›´æ–°æ‰§è¡Œæ—¥å¿—

### 8.4 æ¯é˜¶æ®µå®Œæˆæ—¶

- [ ] å®Œæ•´éªŒè¯
- [ ] æ‰‹åŠ¨æµ‹è¯•å…³é”®åŠŸèƒ½
- [ ] æäº¤ä»£ç 
- [ ] æ›´æ–°æ‰§è¡Œæ—¥å¿—
- [ ] å‡†å¤‡ä¸‹ä¸€é˜¶æ®µ

---

## é™„å½•

### A. ç´§æ€¥è”ç³»äºº

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…æˆ–åœ¨é¡¹ç›®ä¸­åˆ›å»º issueã€‚

### B. å›æ»šè®¡åˆ’

å¦‚æœé‡åˆ°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

```bash
# åˆ‡æ¢åˆ°å¤‡ä»½åˆ†æ”¯
git checkout backup-before-refactoring

# æˆ–è€…æ¢å¤å¤‡ä»½æ–‡ä»¶
rm -rf src/shared
cp -r src/shared.backup src/shared
```

### C. ç›¸å…³æ–‡æ¡£

- [å®Œæ•´ä»»åŠ¡æ¸…å•](./shared-refactoring-complete-checklist.md)
- [é¡¹ç›®è§„åˆ™](../.trae/rules/project_rules.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
**æœ€åæ›´æ–°**ï¼š2026-01-21
**ç»´æŠ¤è€…**ï¼šRoo Code Team
